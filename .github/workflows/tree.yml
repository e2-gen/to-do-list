name: Generate Complete Repository Tree

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  generate-tree:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù„ÙØ§Øª

    - name: Generate complete directory tree
      run: |
        # ØªØ«Ø¨ÙŠØª Ø£Ø¯Ø§Ø© tree Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        if ! command -v tree &> /dev/null; then
          sudo apt-get update
          sudo apt-get install -y tree
        fi

        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù tree.txt
        > tree.txt

        # === 1. Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¬Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ .git) ===
        echo "ğŸŒ³ Complete Repository Structure" >> tree.txt
        echo "========================================" >> tree.txt
        tree -a -I '.git' --dirsfirst -n >> tree.txt
        echo -e "\n\n" >> tree.txt

        # === 2. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù„ÙØ§Øª ===
        echo "ğŸ“Š File Statistics" >> tree.txt
        echo "========================================" >> tree.txt
        echo "Total files: $(find . -type f -not -path './.git/*' | wc -l)" >> tree.txt
        echo "Total directories: $(find . -type d -not -path './.git/*' | wc -l)" >> tree.txt
        echo -e "\n\n" >> tree.txt

        # === 3. Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ===
        echo "ğŸ“„ Contents of All Files" >> tree.txt
        echo "========================================" >> tree.txt

        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ .git) ÙˆÙØ±Ø²Ù‡Ø§
        find . -type f -not -path './.git/*' -not -name 'tree.txt' | sort | while read filepath; do
          filename=$(basename "$filepath")
          dirpath=$(dirname "$filepath")
          
          # ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 1MB)
          filesize=$(stat -c%s "$filepath" 2>/dev/null || stat -f%z "$filepath")
          if [ "$filesize" -gt 1048576 ]; then
            echo -e "\n\n==> $filepath (Skipped - File too large: $(echo "scale=2; $filesize/1048576" | bc) MB) <==" >> tree.txt
            continue
          fi
          
          echo -e "\n\n==> $filepath ($(echo "scale=2; $filesize/1024" | bc) KB) <==" >> tree.txt
          echo "--------------------------------------------------" >> tree.txt
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨
          case "$filename" in
            *.png|*.jpg|*.jpeg|*.gif|*.bmp|*.ico|*.pdf|*.zip|*.tar|*.gz|*.7z|*.rar)
              echo "[Binary file - Content not displayed]" >> tree.txt
              ;;
            *.mp3|*.mp4|*.avi|*.mov|*.wav|*.flac)
              echo "[Media file - Content not displayed]" >> tree.txt
              ;;
            *.exe|*.dll|*.so|*.dylib)
              echo "[Executable file - Content not displayed]" >> tree.txt
              ;;
            *)
              # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù†ØµÙŠ
              if file "$filepath" | grep -q "text"; then
                # Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ 1000 Ø³Ø·Ø± Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø§Ù„Ù†ØµÙŠØ©
                if [ "$(wc -l < "$filepath")" -gt 1000 ]; then
                  head -n 1000 "$filepath" >> tree.txt
                  echo "... [Truncated - File too long]" >> tree.txt
                else
                  cat "$filepath" >> tree.txt
                fi
              else
                echo "[Binary or unsupported text file]" >> tree.txt
              fi
              ;;
          esac
        done

        # === 4. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ===
        echo -e "\n\nğŸ” Repository Information" >> tree.txt
        echo "========================================" >> tree.txt
        echo "Generated on: $(date)" >> tree.txt
        echo "Repository size: $(du -sh . | cut -f1)" >> tree.txt
        echo "Git branch: $(git branch --show-current)" >> tree.txt
        echo "Last commit: $(git log -1 --oneline)" >> tree.txt

    - name: Upload tree.txt as artifact
      uses: actions/upload-artifact@v4
      with:
        name: complete-repository-tree
        path: tree.txt

    - name: Display tree file size
      run: |
        echo "Tree file size: $(du -h tree.txt | cut -f1)"
